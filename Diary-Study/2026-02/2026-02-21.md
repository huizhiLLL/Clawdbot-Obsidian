# 2026-02-21 - SQL 基础 JOIN

## 📚 学习主题

**主题：** SQL 基础 JOIN
**类别：** SQL 基础
**难度：** 初级

---

## 🎯 核心知识点

### 1. 什么是 JOIN？

JOIN 用于在 SQL 查询中结合两个或多个表的行，基于这些表之间的共同字段（通常是外键关系）。

**基本概念：**
- JOIN 允许从多个表中同时获取数据
- 通过关联条件（通常 ON 子句）连接表
- 不同的 JOIN 类型决定如何处理不匹配的行

### 2. INNER JOIN（内连接）

INNER JOIN 只返回两个表中匹配的行，如果某行在另一个表中没有匹配，则不会显示。

**语法：**
```sql
SELECT 列名
FROM 表1
INNER JOIN 表2
ON 表1.列名 = 表2.列名;
```

**示例：** 查询用户及其订单信息
```sql
-- 用户表
users:
┌───┬──────┬─────────────┐
│ id│ name │ email       │
├───┼──────┼─────────────┤
│ 1 │ 张三 │ a@test.com  │
│ 2 │ 李四 │ b@test.com  │
│ 3 │ 王五 │ c@test.com  │
└───┴──────┴─────────────┘

-- 订单表
orders:
┌────┬─────────┬────────┬─────────────┐
│ id │ user_id │ amount │ status      │
├────┼─────────┼────────┼─────────────┤
│ 1  │ 1       │ 100.00 │ paid        │
│ 2  │ 1       │ 200.00 │ shipped     │
│ 3  │ 2       │ 150.00 │ paid        │
└────┴─────────┴────────┴─────────────┘

-- INNER JOIN 查询
SELECT users.name, orders.amount, orders.status
FROM users
INNER JOIN orders ON users.id = orders.user_id;

-- 结果（只显示有订单的用户）
┌──────┬────────┬─────────┐
│ name │ amount │ status  │
├──────┼────────┼─────────┤
│ 张三 │ 100.00 │ paid    │
│ 张三 │ 200.00 │ shipped │
│ 李四 │ 150.00 │ paid    │
└──────┴────────┴─────────┘
```

**注意：** 王五没有订单，所以不会出现在结果中。

### 3. LEFT JOIN（左连接）

LEFT JOIN 返回左表（FROM 后的表）的所有行，即使右表没有匹配。如果没有匹配，右表的列显示为 NULL。

**语法：**
```sql
SELECT 列名
FROM 表1（左表）
LEFT JOIN 表2（右表）
ON 表1.列名 = 表2.列名;
```

**示例：** 查询所有用户及其订单（包括没有订单的用户）
```sql
SELECT users.name, orders.amount, orders.status
FROM users
LEFT JOIN orders ON users.id = orders.user_id;

-- 结果（王五也会显示，订单列为 NULL）
┌──────┬────────┬─────────┐
│ name │ amount │ status  │
├──────┼────────┼─────────┤
│ 张三 │ 100.00 │ paid    │
│ 张三 │ 200.00 │ shipped │
│ 李四 │ 150.00 │ paid    │
│ 王五 │ NULL   │ NULL    │
└──────┴────────┴─────────┘
```

**常见用途：**
- 查找没有关联数据的记录（如没有订单的用户）
- 显示主表的所有数据，关联数据可选

**示例：** 查找没有订单的用户
```sql
SELECT users.name
FROM users
LEFT JOIN orders ON users.id = orders.user_id
WHERE orders.id IS NULL;

-- 结果
┌──────┐
│ name │
├──────┤
│ 王五 │
└──────┘
```

### 4. JOIN 的可视化理解

```
假设有两个集合：A（用户）和 B（订单）

    ┌─────────────┐
    │      A      │         INNER JOIN: 只返回 A ∩ B（交集）
    │   ┌─────┐   │         LEFT JOIN: 返回全部 A
    │   │ A∩B │   │         RIGHT JOIN: 返回全部 B
    │   └─────┘   │         FULL JOIN: 返回 A ∪ B（并集）
    └─────────────┘
          │
          └──────► B
```

### 5. 多表 JOIN

可以连接多个表，只需依次添加 JOIN 子句。

**示例：** 三表连接（用户、订单、商品）
```sql
-- 商品表
products:
┌───┬────────┬───────┐
│ id│ name   │ price │
├───┼────────┼───────┤
│ 1 │ 手机   │ 5000  │
│ 2 │ 电脑   │ 8000  │
│ 3 │ 耳机   │ 200   │
└───┴────────┴───────┘

-- 订单明细表
order_items:
┌────┬─────────┬─────────────┬───────┐
│ id │ order_id│ product_id  │ qty   │
├────┼─────────┼─────────────┼───────┤
│ 1  │ 1       │ 1           │ 1     │
│ 2  │ 1       │ 3           │ 2     │
│ 3  │ 2       │ 2           │ 1     │
└────┴─────────┴─────────────┴───────┘

-- 三表 JOIN 查询
SELECT
    users.name AS 用户名,
    orders.id AS 订单号,
    products.name AS 商品名,
    order_items.qty AS 数量,
    products.price AS 单价
FROM users
INNER JOIN orders ON users.id = orders.user_id
INNER JOIN order_items ON orders.id = order_items.order_id
INNER JOIN products ON order_items.product_id = products.id;

-- 结果
┌────────┬────────┬────────┬───────┬───────┐
│ 用户名 │ 订单号 │ 商品名 │ 数量 │ 单价  │
├────────┼────────┼────────┼───────┼───────┤
│ 张三   │ 1      │ 手机   │ 1     │ 5000  │
│ 张三   │ 1      │ 耳机   │ 2     │ 200   │
│ 张三   │ 2      │ 电脑   │ 1     │ 8000  │
│ 李四   │ 3      │ 手机   │ 1     │ 5000  │
└────────┴────────┴────────┴───────┴───────┘
```

### 6. JOIN 的注意事项

#### 表别名（Table Alias）
给表起简短的别名，让 SQL 更清晰：
```sql
SELECT u.name, o.amount
FROM users AS u
INNER JOIN orders AS o ON u.id = o.user_id;

-- AS 可以省略
SELECT u.name, o.amount
FROM users u
INNER JOIN orders o ON u.id = o.user_id;
```

#### 列名冲突
当两个表有相同列名时，必须指定表名或别名：
```sql
-- 错误：两个表都有 id 列
SELECT id, name FROM users JOIN orders ON users.id = orders.user_id;

-- 正确：使用表名限定
SELECT users.id, users.name FROM users JOIN orders ON users.id = orders.user_id;
```

#### JOIN 性能
- 确保连接的列有索引（通常是主键和外键）
- 先过滤数据再 JOIN（WHERE 子句放在 JOIN 之后）
- 避免不必要的列，只查询需要的字段

---

## 🔗 知识关联

- **与表设计的关系：** 外键设计是 JOIN 的基础，决定了表之间如何关联
- **与 WHERE 的关系：** 可以在 JOIN 后使用 WHERE 进一步过滤结果
- **与 CRUD 的关系：** JOIN 主要用于 SELECT 查询，获取关联数据
- **后续学习：** 学完基础 JOIN 后，可以学习 RIGHT JOIN、FULL JOIN、自连接、子查询等

---

## 📝 练习

### 练习 1：查询用户和订单
查询所有用户的姓名和他们的订单金额（包括没有订单的用户）。

```sql
SELECT users.name, orders.amount
FROM users
LEFT JOIN orders ON users.id = orders.user_id;
```

### 练习 2：查询已支付订单的用户
只查询有已支付订单（status = 'paid'）的用户姓名和订单金额。

```sql
SELECT users.name, orders.amount
FROM users
INNER JOIN orders ON users.id = orders.user_id
WHERE orders.status = 'paid';
```

### 练习 3：三表连接查询
查询订单详情，包括用户名、商品名、数量和单价。

```sql
SELECT
    users.name AS 用户名,
    orders.id AS 订单号,
    products.name AS 商品名,
    order_items.qty AS 数量,
    products.price AS 单价
FROM users
INNER JOIN orders ON users.id = orders.user_id
INNER JOIN order_items ON orders.id = order_items.order_id
INNER JOIN products ON order_items.product_id = products.id;
```

### 练习 4：查找没有下单的用户
查找所有还没有下过订单的用户。

```sql
SELECT users.name
FROM users
LEFT JOIN orders ON users.id = orders.user_id
WHERE orders.id IS NULL;
```

### 练习 5：统计用户订单数量
查询每个用户的订单数量（包括没有订单的用户，显示为 0）。

```sql
SELECT
    users.name,
    COUNT(orders.id) AS order_count
FROM users
LEFT JOIN orders ON users.id = orders.user_id
GROUP BY users.id, users.name;
```

---

## 📚 延伸阅读

### 其他 JOIN 类型
- **RIGHT JOIN（右连接）：** 返回右表的所有行，左表不匹配的显示 NULL
- **FULL JOIN（全连接）：** 返回两个表的所有行，不匹配的显示 NULL（MySQL 不支持）
- **CROSS JOIN（交叉连接）：** 返回两个表的笛卡尔积（每行组合）

### 高级 JOIN 技巧
- **自连接（Self JOIN）：** 表与自身连接，用于查找层级关系
- **子查询 vs JOIN：** 有时候子查询可以转换为 JOIN，性能更好
- **UNION vs JOIN：** UNION 合并结果集，JOIN 关联表数据

### 性能优化建议
1. **索引优化：** 确保 JOIN 条件使用的列有索引
2. **小表驱动大表：** 数据量小的表放在左边，减少比较次数
3. **避免 SELECT *：** 只查询需要的列，减少数据传输
4. **合理使用 LEFT JOIN：** 不需要 NULL 行时使用 INNER JOIN

---

**📅 学习日期：** 2026-02-21
**⏰ 预计学习时间：** 60 分钟

---

## 🧠 测验问题

请回答以下问题，检验你的学习成果：

### 问题 1
INNER JOIN 和 LEFT JOIN 的主要区别是什么？

A. INNER JOIN 更快，LEFT JOIN 更慢
B. INNER JOIN 只返回匹配的行，LEFT JOIN 返回左表的所有行
C. INNER JOIN 可以连接多张表，LEFT JOIN 只能连接两张表
D. INNER JOIN 用主键，LEFT JOIN 用外键

### 问题 2
如果想查询所有用户，包括那些没有订单的用户，应该使用哪种 JOIN？

A. INNER JOIN
B. LEFT JOIN
C. RIGHT JOIN
D. FULL JOIN

### 问题 3
在多表 JOIN 查询中，当两个表有相同名称的列（如 id）时，应该如何避免列名冲突？

A. 自动使用第一个表的列
B. 使用 DISTINCT 去重
C. 使用表名或别名限定列名（如 users.id）
D. 使用 AS 重命名所有列

---

**请将你的答案发送给我，我会帮你检查！** 📝
